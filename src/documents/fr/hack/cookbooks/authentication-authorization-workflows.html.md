---
title: "Authentication and Authorization workflows"
layout: "default"
category: "hack"
menuOrder: 10
toc: true
---

# Authentication and Authorization workflows

Cozy protects the user's data but it would be useless to keep data behind airtight walls. That's why there are specific pipes from which third-party clients (web applications, mobile application, ...) can get the data. How does it work? Let's figure!


## Workflows
**Important Notice**: this is something that can (and that will) change in the future, Cozy is building step by step and architecture decisions cannot be made just on one or two use cases. Feel free to share yours and advise us, we'd love hearing your ideas!

![Authentication and authorization workflows diagram](/assets/images/authentication-workflows.svg)

As you can see, there are 3 entry points, corresponding to 3 use cases. Let's detail them individually.

### The user
The classic use case is the user that authenticate with its password into Cozy and then access applications. How those applications are authorized or not to retrieve data is discussed later on this page.

The user password is salted and hashed using [Bcrypt](http://en.wikipedia.org/wiki/Bcrypt) and is **never** stored as-in in Cozy.

### First-party client
First-party clients are external clients that ask for the user's password for their initialization. The password shouldn't be stored but is used to register the first-party client as a "device" in the Data System. During the intialization, a unique token is generated and transmitted to the client that will use it to authenticate further requests.

Today, there are only clients developoed by Cozycloud that are concerned by this workflow: desktop and mobiles clients for Files synchronization.

For now, the user should only accept to give his password to trusted applications...this is something we'll have to rework in the future.

An other thing subject to future change is the fact that first-party client requests directly goes to CouchDB, that means a godlike access to mess things up.


### Third-party client
If your application cannot be trusted (i.e. is not developped by Cozycloud), you can still choose the third workflow:
* build a Cozy application that asks for the permissions you need
* build an authentication (token based, probably) system in the public part of your application, by generating a token and asking the user to paste this token within the third-party client.

This workflow is not smooth for the user and reinvent the wheels each time by reimplementing the token-based authentication.


### Conclusion
We are going to change things. Nothing has been decided yet and we are more than open to inputs and ideas. First-party and third-party workflows could be unified and standardized. For example, the Data System could be accessed from the outside of a Cozy and the authentication handled by a standard protocol like oAuth, openID, Mozilla Persona, ...


## Applications authentication and permissions
The workflows diagram gives you the big picture but there is one point it lacks to explain: how applications are given permissions. Here is a sequence diagram that will clear your mind about it.

**Note: if the diagrams are too small, click them!**

### Authentication
Applications are authenticated with a unique token, generated by the Home during the installation.
When the Controller starts an application, it passes two environment variables, "NAME" and "TOKEN" that are respectively related to the application's slug and token.

The application can then request the Data System by authenticating its request using the [basic access authentication](http://en.wikipedia.org/wiki/Basic_access_authentication) protocol.

[![Application authentication](/assets/images/app-authentication.png)](/assets/images/app-authentication.png)

### Authorization
When the Data System is requested, it first checks if the user/token corresponds to an application (authentication, see previous part).
Then, it checks if the authenticated application has the permission to access the requested resource.
Those permissions are defined during installation, where the user must explicitely agree on.

[![Application authentication](/assets/images/app-authorization.png)](/assets/images/app-authentication.png)

There are two types of permissions: per doctype permissions and specific permissions.

#### Per doctype permissions
As a reminder, a doctype is a category of data, like "Contact", "Event", "Alarm", "Task", or "MyAppConfiguration", "OrderedList", and so on. You can see a doctype as a sort of SQL table if it helps.

Doctype's permissions are correspond to a single doctype, that means that if the application wants to access the data from 5 different doctypes, it must ask the permission for each doctype.

#### Specific permissions
There are a set of permissions that are not related to doctypes. Here the detailed list:
* all: allow the application to access the data of every doctypes
* device: it is a per-doctype permission but also a specific one since the Data System has an API to manage devices (see first part)
* send mail
* send mail to user
* send mail from user

Others will probably come, it's very flexible system.
