---
title: "Encryption management"
layout: "default"
category: "hack"
menuOrder: 11
toc: true
---

# Encryption management
The Data System can encrypt data to improve their protection. Currently, when there is a "password" field in any document that is posted to the Data System, its value is encrypted.

This is far from being optimal and will probably be improved in the future.

Let's see how it works!

## Encryption and decryption
Two keys are used in encryption and decryption operations.

The first key, called the **master key** is generated from the user password. It is used to encrypt the second key, called the **slave key**, using an AES-256 algorithm. Once encrypted, the slave key is saved in the database. The **master key** stays in memory and is never persisted.

Each user connection, the master key is generated from the user password and a salt.

![How encryption keys are generated](/assets/images/encryption-workflow.jpg)

Keys initialization is managed by the request `POST /accounts/password/` in the Data System. It generates the master key and recovers encrypted slave key from database. The Proxy requests the Data-System to initialize the keys at each user connection.

## Change user password
When user changes his password, master key is modified since it is generated by user password and a salt. New master key is generated and old master key is known because the user is logged.

Slave key is encrypted by the new master key.

![How encryption keys are regenerated when the user changes its password](/assets/images/encryption-password-modification.jpg)

This operation is managed by the request `PUT /accounts/password` in the Data System.

## Reset user password
When the user forgets its password, the slave key cannot be decrypted anymore since the old master key isn't known. Thus, encrypted data can't be decrypted.

A new slave key must be generated to encrypt new data.

Data have a witness which is a known encrypted string like account password. If we can't decrypt correctly the witness, it means data are corrupted. It's the case after a password reset since the new slave key doesn't correspond anymore.

This operation is managed by the request `DELETE /accounts/reset` in the Data System.

## Limitations

### Reset user password
As mentioned above, the reset of the user password is a critical operation since it means the lost of every encrypted data. The corrupted data must be removed manually (if no applications take care of it) and eventually recreated.

### Restart the Data System
Another limitation is when the Data System is restarted. The user must log in afterwards otherwise the master key won't be found, resulting in the Data System unable to decrypt data.

### Security concern
If an attacker gains a root access he can scans the memory to retrieve the user password, or at least the master key.

Applications are run with their own (non-sudoer) user so they can't do that.

